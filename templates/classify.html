{% extends 'layout.html' %}

{% block title %}Phân Loại Phân Khúc Xe{% endblock %}

{% block content %}
<div class="classification-container">
    <section class="classification-header">
        <div class="row">
            <div class="col-lg-8">
                <h1 class="page-title">Phân Loại Phân Khúc Xe</h1>
                <p class="lead">Công cụ phân loại tự động xe ô tô theo phân khúc giá và tính năng</p>
            </div>
        </div>
    </section>

    <div class="row mt-4">
        <div class="col-lg-5">
            <div class="card classify-form-card">
                <div class="card-header">
                    <h2 class="card-title">Nhập thông tin xe</h2>
                    <p class="card-subtitle">Nhập các thông số kỹ thuật để phân loại xe</p>
                </div>
                <div class="card-body">
                    <form action="/classify" method="post" id="classifyForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="c-brand" class="form-label">
                                        <i class="fas fa-trademark me-2"></i>Thương hiệu
                                    </label>
                                    <select class="form-select" id="c-brand" name="brand" required>
                                        <option value="" selected disabled>Chọn thương hiệu</option>
                                        <option value="Toyota">Toyota</option>
                                        <option value="Honda">Honda</option>
                                        <option value="Mazda">Mazda</option>
                                        <option value="Ford">Ford</option>
                                        <option value="Kia">Kia</option>
                                        <option value="Hyundai">Hyundai</option>
                                        <option value="Mercedes-Benz">Mercedes-Benz</option>
                                        <option value="BMW">BMW</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="c-year" class="form-label">
                                        <i class="fas fa-calendar-alt me-2"></i>Năm sản xuất
                                    </label>
                                    <select class="form-select" id="c-year" name="year" required>
                                        <option value="" selected disabled>Chọn năm</option>
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                        {% for year in range(2023, 1990, -1) %}
                                        <option value="{{ year }}">{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="c-engine" class="form-label">
                                        <i class="fas fa-tachometer-alt me-2"></i>Dung tích động cơ
                                    </label>
                                    <input type="number" class="form-control" id="c-engine" name="engine_capacity" 
                                        step="0.1" min="0.5" max="8.0" placeholder="Ví dụ: 2.0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="c-body" class="form-label">
                                        <i class="fas fa-car me-2"></i>Kiểu dáng
                                    </label>
                                    <select class="form-select" id="c-body" name="body_type" required>
                                        <option value="" selected disabled>Chọn kiểu dáng</option>
                                        <option value="Sedan">Sedan</option>
                                        <option value="SUV">SUV</option>
                                        <option value="Hatchback">Hatchback</option>
                                        <option value="MPV">MPV</option>
                                        <option value="Crossover">Crossover</option>
                                        <option value="Pickup">Pickup</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="c-fuel" class="form-label">
                                        <i class="fas fa-gas-pump me-2"></i>Loại nhiên liệu
                                    </label>
                                    <select class="form-select" id="c-fuel" name="fuel_type" required>
                                        <option value="" selected disabled>Chọn loại nhiên liệu</option>
                                        <option value="Xăng">Xăng</option>
                                        <option value="Dầu">Dầu</option>
                                        <option value="Hybrid">Hybrid</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="c-origin" class="form-label">
                                        <i class="fas fa-globe me-2"></i>Xuất xứ
                                    </label>
                                    <select class="form-select" id="c-origin" name="origin" required>
                                        <option value="" selected disabled>Chọn xuất xứ</option>
                                        <option value="Nhập khẩu">Nhập khẩu</option>
                                        <option value="Trong nước">Trong nước</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="c-transmission" class="form-label">
                                        <i class="fas fa-cogs me-2"></i>Hộp số
                                    </label>
                                    <select class="form-select" id="c-transmission" name="transmission" required>
                                        <option value="" selected disabled>Chọn loại hộp số</option>
                                        <option value="Số tự động">Số tự động</option>
                                        <option value="Số sàn">Số sàn</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="c-mileage" class="form-label">
                                        <i class="fas fa-road me-2"></i>Số km đã đi
                                    </label>
                                    <input type="number" class="form-control" id="c-mileage" name="mileage_km" min="0" step="1" required placeholder="Nhập số km ">
                                </div>
                            </div>
                        </div>



                        <div class="text-center mt-4">
                            <button type="button" id="classifyButton" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-tags me-2"></i>Phân loại xe
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card result-card">
                <div class="card-header">
                    <h2 class="card-title">Kết quả phân loại</h2>
                    <p class="card-subtitle">Phân khúc xe dựa trên thuật toán phân loại</p>
                </div>
                <div class="card-body">
                    <div id="classificationResult">
                        <div class="placeholder-result text-center py-5">
                            <i class="fas fa-tag fa-4x text-muted mb-3"></i>
                            <h3>Chưa có kết quả phân loại</h3>
                            <p class="text-muted">Hãy nhập thông tin xe và nhấn nút "Phân loại xe" để xem kết quả.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">Thông tin các phân khúc xe</h3>
                </div>
                <div class="card-body">
                    <div class="accordion" id="segmentAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingLuxury">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLuxury" aria-expanded="false" aria-controls="collapseLuxury">
                                    <span class="segment-badge luxury">Luxury</span> Phân khúc xe sang
                                </button>
                            </h2>
                            <div id="collapseLuxury" class="accordion-collapse collapse" aria-labelledby="headingLuxury" data-bs-parent="#segmentAccordion">
                                <div class="accordion-body">
                                    <p>Các xe thuộc phân khúc sang có giá <strong>trên 1.46 tỷ đồng</strong>, thường thuộc các thương hiệu như Mercedes-Benz, BMW, Lexus, Audi, Porsche. Các xe này có trang bị cao cấp, công nghệ hiện đại và thương hiệu uy tín.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingPremium">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePremium" aria-expanded="false" aria-controls="collapsePremium">
                                    <span class="segment-badge premium">Premium</span> Phân khúc cao cấp
                                </button>
                            </h2>
                            <div id="collapsePremium" class="accordion-collapse collapse" aria-labelledby="headingPremium" data-bs-parent="#segmentAccordion">
                                <div class="accordion-body">
                                    <p>Các xe thuộc phân khúc cao cấp có giá <strong>từ 720 triệu đến 1.46 tỷ đồng</strong>, thường là các mẫu top-end của thương hiệu phổ thông hoặc mẫu entry-level của thương hiệu hạng sang.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingMid">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMid" aria-expanded="false" aria-controls="collapseMid">
                                    <span class="segment-badge mid">Mid-range</span> Phân khúc trung cấp
                                </button>
                            </h2>
                            <div id="collapseMid" class="accordion-collapse collapse" aria-labelledby="headingMid" data-bs-parent="#segmentAccordion">
                                <div class="accordion-body">
                                    <p>Các xe thuộc phân khúc trung cấp có giá từ 500 đến 800 triệu đồng, thường là các mẫu xe phổ biến có trang bị khá đầy đủ và thoải mái.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingEconomy">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEconomy" aria-expanded="false" aria-controls="collapseEconomy">
                                    <span class="segment-badge economy">Economy</span> Phân khúc tiết kiệm
                                </button>
                            </h2>
                            <div id="collapseEconomy" class="accordion-collapse collapse" aria-labelledby="headingEconomy" data-bs-parent="#segmentAccordion">
                                <div class="accordion-body">
                                    <p>Các xe thuộc phân khúc tiết kiệm có giá dưới 500 triệu đồng, chủ yếu là các mẫu xe nhỏ gọn, tiết kiệm nhiên liệu, phù hợp với đô thị.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('classifyButton').addEventListener('click', function() {
            const form = document.getElementById('classifyForm');
            const formData = new FormData(form);
            
            // Validate form
            const brand = document.getElementById('c-brand').value;
            const year = document.getElementById('c-year').value;
            const engine = document.getElementById('c-engine').value;
            const bodyType = document.getElementById('c-body').value;
            const fuelType = document.getElementById('c-fuel').value;
            const origin = document.getElementById('c-origin').value;
            const transmission = document.getElementById('c-transmission').value;
            const mileage = document.getElementById('c-mileage').value;
            
            if (!brand || !year || !engine || !bodyType || !fuelType || !origin || !transmission || !mileage) {
                alert('Vui lòng điền đầy đủ thông tin bắt buộc');
                return;
            }
            
            document.getElementById('classificationResult').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-3">Đang phân tích dữ liệu xe...</p>
                </div>
            `;

            fetch('/classify', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.log('Error response text:', text);
                        throw new Error(`Server error: ${response.status} - ${text.substring(0, 100)}...`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
  
                const segment = data.segment;
                const confidence = data.confidence;
                const formattedPrice = data.formatted_price;
                const similarModels = data.similar_models || [];
    
                let segmentColor = '';
                switch(segment) {
                    case 'Luxury': segmentColor = 'luxury'; break;
                    case 'Premium': segmentColor = 'premium'; break;
                    case 'Mid-range': segmentColor = 'mid'; break;
                    case 'Economy': segmentColor = 'economy'; break;
                }
                
                const resultHTML = `
                    <div class="classification-result">
                        <div class="result-header">
                            <h3 class="car-name">${brand} (${year})</h3>
                            <span class="segment-badge ${segmentColor}">${segment}</span>
                        </div>
                        
                        <div class="result-details mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <i class="fas fa-car me-2"></i>
                                        <span class="info-label">Kiểu dáng:</span> 
                                        <span class="info-value">${bodyType}</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-tachometer-alt me-2"></i>
                                        <span class="info-label">Động cơ:</span> 
                                        <span class="info-value">${engine} lít</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <i class="fas fa-money-bill-wave me-2"></i>
                                        <span class="info-label">Giá dự đoán:</span> 
                                        <span class="info-value">${formattedPrice}</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-percent me-2"></i>
                                        <span class="info-label">Độ tin cậy:</span> 
                                        <span class="info-value">${confidence}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="segment-description mt-4">
                            <div class="alert alert-info">
                                <h5 class="alert-heading">Thông tin phân khúc ${segment}</h5>
                                ${getSegmentDescription(segment)}
                            </div>
                        </div>
                        
                        <div class="similar-models mt-4">
                            <h5>Các mẫu xe tương tự</h5>
                            <div class="row">
                                ${generateSimilarModelsHTML(similarModels, segment)}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('classificationResult').innerHTML = resultHTML;
            })
            .catch(error => {
                document.getElementById('classificationResult').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Lỗi:</strong> ${error.message}
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-primary" onclick="location.reload()">
                            <i class="fas fa-refresh me-2"></i>Thử lại
                        </button>
                    </div>
                `;
            });
        });

        function getSegmentDescription(segment) {
            switch(segment) {
                case 'Luxury':
                    return '<p>Phân khúc xe sang là những mẫu xe cao cấp nhất trên thị trường, với giá <strong>trên 1.46 tỷ đồng</strong>. Các xe này thường có đầy đủ tính năng cao cấp, thiết kế sang trọng và thương hiệu uy tín.</p>';
                case 'Premium':
                    return '<p>Phân khúc xe cao cấp với giá <strong>từ 720 triệu đến 1.46 tỷ đồng</strong>, thường là các mẫu top-end của thương hiệu phổ thông hoặc mẫu entry-level của thương hiệu hạng sang.</p>';
                case 'Mid-range':
                    return '<p>Phân khúc xe trung cấp với giá từ 500 đến 800 triệu đồng, là lựa chọn phổ biến với nhiều người dùng vì cân bằng giữa chi phí và tính năng.</p>';
                case 'Economy':
                    return '<p>Phân khúc xe tiết kiệm với giá dưới 500 triệu đồng, chủ yếu là các mẫu xe nhỏ gọn, tiết kiệm nhiên liệu, phù hợp với đô thị.</p>';
                default:
                    return '';
            }
        }
        
        function generateSimilarModelsHTML(similarModels, defaultSegment) {
            if (!similarModels || similarModels.length === 0) {
                const defaultModels = {
                    'Luxury': [
                        { brand: 'Mercedes-Benz', model: 'E-Class' },
                        { brand: 'BMW', model: '5 Series' },
                        { brand: 'Lexus', model: 'ES' }
                    ],
                    'Premium': [
                        { brand: 'Toyota', model: 'Camry' },
                        { brand: 'Honda', model: 'Accord' },
                        { brand: 'Mazda', model: 'CX-5' }
                    ],
                    'Mid-range': [
                        { brand: 'Honda', model: 'Civic' },
                        { brand: 'Toyota', model: 'Corolla Cross' },
                        { brand: 'Mazda', model: '3' }
                    ],
                    'Economy': [
                        { brand: 'Kia', model: 'Morning' },
                        { brand: 'Hyundai', model: 'i10' },
                        { brand: 'Toyota', model: 'Wigo' }
                    ]
                };
                
                similarModels = defaultModels[defaultSegment] || defaultModels['Mid-range'];
            }
            
            let html = '';
            
            for (let i = 0; i < similarModels.length; i++) {
                const model = similarModels[i];
                const segmentClass = (model.segment || defaultSegment).toLowerCase();
                
                html += `
                <div class="col-md-4">
                    <div class="similar-model-card">
                        <div class="model-name">${model.brand} ${model.model}</div>
                        <div class="model-segment">
                            <span class="segment-badge ${segmentClass}">${model.segment || defaultSegment}</span>
                        </div>
                    </div>
                </div>
                `;
            }
            
            return html;
        }
    });
</script>
{% endblock %}
